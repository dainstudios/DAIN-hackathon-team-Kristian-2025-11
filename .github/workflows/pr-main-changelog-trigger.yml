name: Notify on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  notify:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # get full history so we can diff properly

      - name: Extract PR info and changes
        id: changes
        run: |
          # Get the merge commit SHA
          MERGE_COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"

          # Get the base (target branch before merge)
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          
          # Get commits included in this PR
          COMMITS=$(git log --oneline "${BASE_REF}..${MERGE_COMMIT_SHA}")
          
          # Get diff summary (only filenames and stats)
          DIFF=$(git diff --stat "${BASE_REF}" "${MERGE_COMMIT_SHA}")

          # Encode to safe JSON for curl
          COMMITS_ESCAPED=$(echo "$COMMITS" | jq -Rs .)
          DIFF_ESCAPED=$(echo "$DIFF" | jq -Rs .)
          
          echo "commits=$COMMITS_ESCAPED" >> $GITHUB_OUTPUT
          echo "diff=$DIFF_ESCAPED" >> $GITHUB_OUTPUT

      - name: Prepare JSON payload
        id: payload
        run: |
          # Build JSON payload and store it in a file for both echo and curl
          cat <<EOF > payload.json
          {
            "repo": "${{ github.repository }}",
            "pr_title": "${{ github.event.pull_request.title }}",
            "pr_body": "${{ github.event.pull_request.body }}",
            "pr_number": "${{ github.event.pull_request.number }}",
            "merged_by": "${{ github.event.pull_request.merged_by.login }}",
            "commits": ${{ steps.changes.outputs.commits }},
            "diff": ${{ steps.changes.outputs.diff }}
          }
          EOF

          echo "=== Debug Payload Preview ==="
          cat payload.json
          
      - name: Call n8n Webhook
        env:
          N8N_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          echo "Sending payload to n8n..."
          curl -s -o response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$N8N_URL" | tee http_status.txt

          STATUS=$(cat http_status.txt)
          echo "n8n HTTP Status: $STATUS"

          echo "--- n8n Response ---"
          cat response.txt
